---
# Application deployment tasks

- name: Create kubernetes manifests directory
  file:
    path: /opt/product-management/k8s
    state: directory
    mode: '0755'

- name: Copy Kubernetes manifests
  copy:
    src: "{{ playbook_dir }}/../../k8s/"
    dest: /opt/product-management/k8s/
    mode: '0644'

- name: Apply namespace
  kubernetes.core.k8s:
    state: present
    src: /opt/product-management/k8s/namespace.yaml

- name: Apply ConfigMaps
  kubernetes.core.k8s:
    state: present
    src: /opt/product-management/k8s/configmap.yaml

- name: Apply Secrets
  kubernetes.core.k8s:
    state: present
    src: /opt/product-management/k8s/secrets.yaml

- name: Apply PostgreSQL PVC
  kubernetes.core.k8s:
    state: present
    src: /opt/product-management/k8s/postgres-pvc.yaml

- name: Apply PostgreSQL Deployment
  kubernetes.core.k8s:
    state: present
    src: /opt/product-management/k8s/postgres-deployment.yaml

- name: Wait for PostgreSQL to be ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: product-management
    label_selectors:
      - app=postgres
    wait: yes
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: 300

- name: Apply Backend Deployment
  kubernetes.core.k8s:
    state: present
    src: /opt/product-management/k8s/backend-deployment.yaml

- name: Apply Frontend Deployment
  kubernetes.core.k8s:
    state: present
    src: /opt/product-management/k8s/frontend-deployment.yaml

- name: Apply HPA
  kubernetes.core.k8s:
    state: present
    src: /opt/product-management/k8s/hpa.yaml

- name: Apply Ingress
  kubernetes.core.k8s:
    state: present
    src: /opt/product-management/k8s/ingress.yaml
  when: ingress_enabled | default(false)

- name: Get service information
  kubernetes.core.k8s_info:
    kind: Service
    namespace: product-management
    name: frontend-service
  register: frontend_service

- name: Display access information
  debug:
    msg: "Application deployed! Access via: {{ frontend_service.resources[0].status.loadBalancer.ingress[0].ip if frontend_service.resources[0].status.loadBalancer.ingress is defined else 'Pending...' }}"
