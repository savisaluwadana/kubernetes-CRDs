---
# Ansible playbook for LOCAL deployment with Colima/Kubernetes

- name: Setup Local Kubernetes Environment
  hosts: localhost
  connection: local
  gather_facts: yes
  become: no
  
  vars:
    project_dir: "{{ playbook_dir }}/../.."
    namespace: product-management
    
  tasks:
    - name: Check if Colima is installed
      command: which colima
      register: colima_check
      failed_when: false
      changed_when: false
    
    - name: Check if kubectl is installed
      command: which kubectl
      register: kubectl_check
      failed_when: false
      changed_when: false
    
    - name: Fail if Colima is not installed
      fail:
        msg: "Colima is not installed. Install with: brew install colima"
      when: colima_check.rc != 0
    
    - name: Fail if kubectl is not installed
      fail:
        msg: "kubectl is not installed. Install with: brew install kubectl"
      when: kubectl_check.rc != 0
    
    - name: Check Colima status
      command: colima status
      register: colima_status
      failed_when: false
      changed_when: false
    
    - name: Display Colima status
      debug:
        msg: "{{ colima_status.stdout }}"
    
    - name: Check if Kubernetes cluster is accessible
      command: kubectl cluster-info
      register: k8s_cluster
      failed_when: false
      changed_when: false
    
    - name: Display cluster info
      debug:
        msg: "{{ k8s_cluster.stdout }}"
    
    - name: Create namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ namespace }}"
    
    - name: Apply ConfigMaps
      kubernetes.core.k8s:
        state: present
        src: "{{ project_dir }}/k8s/configmap.yaml"
    
    - name: Apply Secrets
      kubernetes.core.k8s:
        state: present
        src: "{{ project_dir }}/k8s/secrets.yaml"
    
    - name: Apply PostgreSQL PVC
      kubernetes.core.k8s:
        state: present
        src: "{{ project_dir }}/k8s/postgres-pvc.yaml"
    
    - name: Apply PostgreSQL Deployment
      kubernetes.core.k8s:
        state: present
        src: "{{ project_dir }}/k8s/postgres-deployment.yaml"
    
    - name: Wait for PostgreSQL to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ namespace }}"
        label_selectors:
          - app=postgres
        wait: yes
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: 300
      register: postgres_pods
    
    - name: Display PostgreSQL status
      debug:
        msg: "PostgreSQL is ready!"
    
    - name: Apply Backend Deployment
      kubernetes.core.k8s:
        state: present
        src: "{{ project_dir }}/k8s/backend-deployment.yaml"
    
    - name: Apply Frontend Deployment
      kubernetes.core.k8s:
        state: present
        src: "{{ project_dir }}/k8s/frontend-deployment.yaml"
    
    - name: Wait for Backend pods
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ namespace }}"
        label_selectors:
          - app=backend
        wait: yes
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: 300
    
    - name: Wait for Frontend pods
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ namespace }}"
        label_selectors:
          - app=frontend
        wait: yes
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: 300
    
    - name: Get all pods
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ namespace }}"
      register: all_pods
    
    - name: Display pod status
      debug:
        msg: "Pod {{ item.metadata.name }}: {{ item.status.phase }}"
      loop: "{{ all_pods.resources }}"
    
    - name: Get services
      kubernetes.core.k8s_info:
        kind: Service
        namespace: "{{ namespace }}"
      register: services
    
    - name: Display services
      debug:
        msg: "Service {{ item.metadata.name }}: {{ item.spec.type }} - Port {{ item.spec.ports[0].port }}"
      loop: "{{ services.resources }}"
    
    - name: Display access information
      debug:
        msg: |
          ================================
          Deployment Complete!
          ================================
          
          Access your application:
          
          1. Frontend (port-forward):
             kubectl port-forward svc/frontend-service 3000:80 -n {{ namespace }}
             Then visit: http://localhost:3000
          
          2. Backend (port-forward):
             kubectl port-forward svc/backend-service 5000:5000 -n {{ namespace }}
             Then visit: http://localhost:5000/health
          
          3. View pods:
             kubectl get pods -n {{ namespace }}
          
          4. View logs:
             kubectl logs -f deployment/backend -n {{ namespace }}
             kubectl logs -f deployment/frontend -n {{ namespace }}
          
          5. Scale deployment:
             kubectl scale deployment backend --replicas=3 -n {{ namespace }}
